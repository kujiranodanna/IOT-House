#!/bin/bash
# The MIT License
# Copyright (c) 2020-2027 Isamu.Yamauchi , 2011.11.28 update 2020.12.7
# pepoliveserver ;  liveserver for raspberry pi
# pepoliveserver dev timer
PATH=$PATH:/usr/local/bin:/usr/local/sbin
WORKDIR=/www/remote-hand/tmp
pid=`echo $$`
prog=pepoliveserver
pidfile=/var/run/${prog}.pid
LIVEFILE=${WORKDIR}/remote-hand.webm
VIDEOPG=avconv
RASPICAMERA=/dev/vchiq
RASPIVID=raspivid
TIMER=45000
VIDEOSIZE=320x240
VIDEORATE=1
PEPORASPVIDEO=/usr/local/bin/peporaspvid
if [ $# -lt 1 -o $# -gt 2 ];then
  echo "usage: $0 /dev/video0 | timer(seconds)"
  exit
fi
DEV=$1
if [ ! -e $DEV ];then
  echo $1 not found ;exit
fi
error(){
  if [ -e $pidfile ];then
    VIDEOPG_PID=`pgrep ${VIDEOPG}` ; [ ! -z ${VIDEOPG_PID} ] && kill -HUP ${VIDEOPG_PID}
    VIDEOPG_PID=`pgrep ${RASPIVID}` ; [ ! -z ${VIDEOPG_PID} ] && kill -HUP ${VIDEOPG_PID}
    VIDEOSERVER_PID=`pgrep ${VIDEOSV}` ; [ ! -z ${VIDEOSERVER_PID} ] && kill -HUP ${VIDEOSERVER_PID}
    rm -f $pidfile
  fi
  exit
}
trap error SIGINT SIGTERM SIGHUP SIGKILL SIGCHLD
if [ -e $pidfile ];then
  tpid=`cat $pidfile`
  kill -HUP $tpid
  msleep 1000
  [ -e $pidfile ] && rm -f $pidfile
fi
if [ $DEV = $RASPICAMERA ];then
  VIDEOSIZE=640x480
  VIDEORATE=10
fi
[ $# = 2 ] && TIMER=$2
MSLEEP=$(($TIMER * 1))
RASPITIMER=$(($TIMER - 0))
OPT="-codec libvpx -pix_fmt yuv420p"
if [ $DEV = $RASPICAMERA ];then
  VIDEOPG_PID=`pgrep ${RASPIVID}` ; [ ! -z ${VIDEOPG_PID} ] && kill -HUP ${VIDEOPG_PID}
fi
VIDEOPG_PID=`pgrep ${VIDEOPG}` ; [ ! -z ${VIDEOPG_PID} ] && kill -HUP ${VIDEOPG_PID}
VIDEOSERVER_PID=`pgrep ${VIDEOSV}` ; [ ! -z ${VIDEOSERVER_PID} ] && kill -HUP ${VIDEOSERVER_PID}
msleep 100
[ -e $pidfile ] && rm -f $pidfile
echo -n $pid >${pidfile}
#[ -e ${LIVEFILE} ] && rm -f ${LIVEFILE}
#${VIDEOSV} -v verbose >/dev/null 2>&1 &
if [ $DEV = $RASPICAMERA ];then
#  ${RASPIVID} -vf -hf -o - -w 640 -h 480 -t $RASPITIMER -b 500000 -fps 2 | \
  ${RASPIVID} -o - -w 640 -h 480 -t $RASPITIMER -b 500000 -fps 2 | \
  ${VIDEOPG} -f h264 -r 2 -i - -vcodec flv http://$IP:8090/remote-hand.ffm >/dev/null 2>&1 &
else
  ${VIDEOPG} -f video4linux2 -r $VIDEORATE -s $VIDEOSIZE -i $DEV $OPT -y $LIVEFILE >/dev/null 2>&1 &
fi
KILLSLEEP=$(($MSLEEP + 10000))
KILLSLEEP=$(($KILLSLEEP / 100))
while [ $KILLSLEEP -gt 0 ];do
  msleep 100
  KILLSLEEP=$(($KILLSLEEP - 1))
done
kill -TERM $pid
