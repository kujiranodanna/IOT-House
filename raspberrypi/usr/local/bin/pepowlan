#!/bin/bash
# licence GPLv2 ; this scripts was designed by IZAMUKARERA 2012.3.19 update 2018.2.24
# pepowlan for daemon contorl Wireless Lan.
# configure file /etc/wlan/wlan.conf
PATH=$PATH:/usr/local/bin:/usr/local/sbin
CONF=/etc/wlan/wlan.conf
WORK=/var/tmp/pepowlan
prog=pepowlan
pidfile=/var/run/$prog.pid
echo -en $$ >$pidfile
WAIT=3000
error () {
  [ -e $WORK ] && rm -f $WORK
  [ ! -z $WLAN_YES ] && ifconfig wlan0 down 2>&1
  exit 0
}
trap error SIGKILL SIGTERM SIGHUP SIGINT

while true ;do
  iwconfig >$WORK 2>&1
  WLAN=`cat $WORK |grep wlan|wc -l`
  [ $WLAN != "0" ] && WLAN_YES="yes" || WLAN_YES="no"
  while [ $WLAN_YES = "yes" ];do
    iwconfig >$WORK 2>&1
    WLAN=`cat $WORK |grep wlan|grep off|wc -l`
    WLAN_BITRATE=`cat $WORK |grep "Bit Rate"|wc -l`
    if [ $WLAN != "0" ] || [ $WLAN_BITRATE = "0" ];then
      WLAN="down"
    else
      WLAN="up"
      if [ ! -z $GATEWAY ];then
        DEFAULT=`ip route |grep default|wc -l`
        [ $DEFAULT != "0" ] && ip route del default
        msleep $WAIT
        ip route add default via $GATEWAY >/dev/null 2>&1 || break
      fi
    fi
    if [ $WLAN = "down" ];then
      if [ ! -e $CONF ];then
        break
      else
        . $CONF
        msleep $WAIT
        [ ! -z $ESSID ] && iwconfig wlan0 essid $ESSID >/dev/null 2>&1 || break
        [ ! -z  $ENCKEY ] && iwconfig wlan0 enc $ENCKEY >/dev/null 2>&1 || break
        msleep $WAIT
        if [ ! -z $IP ] && [ $IP = "dhcp" ];then
          killall dhclient >/dev/null 2>&1
          msleep $WAIT
          dhclient wlan0 >/dev/null 2>&1
        fi
        if [ ! -z $IP ] && [ $IP != "dhcp" ];then
          [ ! -z $IP ] && ifconfig wlan0 $IP up >/dev/null 2>&1 || break
          msleep $WAIT
          if [ ! -z $NAMESERVER ];then
            cat>/etc/resolv.conf<<END
; generated by /usr/local/bin/pepowaln script
search localdomain
nameserver $NAMESERVER
END
          fi
        fi
      fi
    fi
    [ -e $WORK ] && rm -f $WORK
    msleep 10000
  done
  [ -e $WORK ] && rm -f $WORK
  msleep 10000
done
