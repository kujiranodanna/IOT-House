#!/bin/bash
# The MIT License
# Copyright (c) 2022-2027 Isamu.Yamauchi , 2025.12.26 update 2026.1.23
####################################################################################
# What's this?
# This script allows you to write RP2040 programs up to approximately 250 lines.
# This program requires epicon.
# Please install it by following the instructions below.
# https://github.com/kujiranodanna/epicon
####################################################################################
DIR=/www/remote-hand/tmp
prog=peporp2040pgwrite
pid=`echo -n $$`
CMD="${DIR}/$prog.cmd"
RPICMD="${DIR}/RP2040.cmd"
DIO_DEV=/dev/ttyACM0
EPICON_TTY_LOCK="/var/lock/LCK..ttyacm0"
EPICON_SOCKET="/var/lock/epicon_socket.*"
CMD_DIO="/usr/local/bin/epicon -ql ${DIO_DEV} -s 115200 -d 5 -D 50 -c ${CMD}"
EPICON_SOCKET=/var/lock/epicon_socket.*
[ -e $EPICON_TTY_LOCK ] && rm $EPICON_TTY_LOCK
[ -e $EPICON_SOCKET ] && rm $EPICON_SOCKET
cat >${CMD}<<END
#!/bin/bash
#cat >${RPICMD}<<EOF
echo
# Send Ctl-C ,Break
printf "\003"
msleep 2000
# Send Ctl-E , Copy & Paste Mode
printf "\005"
echo
msleep 2000
cat <<EOF

########### Please write the RP2040 program below. ###########

import time
from machine import Pin
import rp2
etc.
.


########### Please write the RP2040 program above this. ###########

EOF

msleep 1000
# Send  Ctl-D, Copy & Paste Mode Release
printf "\004"

msleep 2000
echo
echo
END
chmod +x ${CMD}
${CMD}
[ -e $EPICON_TTY_LOCK ] && rm $EPICON_TTY_LOCK
[ -e $EPICON_SOCKET ] && rm $EPICON_SOCKET
echo -en "\nRP2040 Program Writer Start\n"
${CMD_DIO}
rm -f ${RPICMD} ${CMD}
echo -en "\nRP2040 Program Writer End\n"
exit
